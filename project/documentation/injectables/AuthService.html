<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>emergency-response-system documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">emergency-response-system documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">








<ol class="breadcrumb">
  <li class="breadcrumb-item">Injectables</li>
  <li class="breadcrumb-item" >AuthService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/auth/auth.service.ts</code>
        </p>





            <section data-compodoc="block-index">
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>
                <tr>
                    <td class="col-md-4">
                        <h6><b>Properties</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Private</span>
                                    <span class="modifier">Readonly</span>
                                <a href="#logger" >logger</a>
                            </li>
                            <li>
                                    <span class="modifier">Private</span>
                                <a href="#supabase" >supabase</a>
                            </li>
                        </ul>
                    </td>
                </tr>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Async</span>
                                <a href="#findOrCreateUser" >findOrCreateUser</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#generateAuthUrl" >generateAuthUrl</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                    <span class="modifier">Async</span>
                                <a href="#getUserFromAccessToken" >getUserFromAccessToken</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#handleOAuthCallback" >handleOAuthCallback</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#login" >login</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#loginWithSupabaseToken" >loginWithSupabaseToken</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#refreshToken" >refreshToken</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#register" >register</a>
                            </li>
                            <li>
                                    <span class="modifier">Public</span>
                                <a href="#signJwt" >signJwt</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#validateToken" >validateToken</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section data-compodoc="block-constructor">
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(configService: ConfigService, jwtService: JwtService, prisma: <a href="../injectables/PrismaService.html" target="_self">PrismaService</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="27" class="link-to-prism">src/auth/auth.service.ts:27</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>configService</td>
                                                  
                                                        <td>
                                                                    <code>ConfigService</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>jwtService</td>
                                                  
                                                        <td>
                                                                    <code>JwtService</code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                                <tr>
                                                        <td>prisma</td>
                                                  
                                                        <td>
                                                                        <code><a href="../injectables/PrismaService.html" target="_self" >PrismaService</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section data-compodoc="block-methods">
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="findOrCreateUser"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Async</span>
                        <span ><b>findOrCreateUser</b></span>
                        <a href="#findOrCreateUser"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>findOrCreateUser(supabaseUser: <a href="../interfaces/SupabaseUser.html" target="_self">SupabaseUser</a>, provider: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="263"
                                    class="link-to-prism">src/auth/auth.service.ts:263</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Find existing user or create a new one based on OAuth user data</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>supabaseUser</td>
                                            <td>
                                                            <code><a href="../interfaces/SupabaseUser.html" target="_self" >SupabaseUser</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>provider</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="generateAuthUrl"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>generateAuthUrl</b></span>
                        <a href="#generateAuthUrl"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>generateAuthUrl(provider: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="169"
                                    class="link-to-prism">src/auth/auth.service.ts:169</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Generates an authorization URL for the specified OAuth provider</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>provider</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;string&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="getUserFromAccessToken"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                            <span class="modifier">Async</span>
                        <span ><b>getUserFromAccessToken</b></span>
                        <a href="#getUserFromAccessToken"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>getUserFromAccessToken(accessToken: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="448"
                                    class="link-to-prism">src/auth/auth.service.ts:448</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>accessToken</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/SupabaseUser.html" target="_self" >Promise&lt;SupabaseUser&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="handleOAuthCallback"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>handleOAuthCallback</b></span>
                        <a href="#handleOAuthCallback"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>handleOAuthCallback(provider: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>, code: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="213"
                                    class="link-to-prism">src/auth/auth.service.ts:213</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Handles the OAuth callback from providers</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>provider</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                        <tr>
                                                <td>code</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/AuthTokens.html" target="_self" >Promise&lt;AuthTokens&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="login"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>login</b></span>
                        <a href="#login"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>login(loginDto: <a href="../classes/LoginDto.html" target="_self">LoginDto</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="101"
                                    class="link-to-prism">src/auth/auth.service.ts:101</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Login with email and password</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>loginDto</td>
                                            <td>
                                                            <code><a href="../classes/LoginDto.html" target="_self" >LoginDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/AuthTokens.html" target="_self" >Promise&lt;AuthTokens&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="loginWithSupabaseToken"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>loginWithSupabaseToken</b></span>
                        <a href="#loginWithSupabaseToken"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>loginWithSupabaseToken(access_token: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="409"
                                    class="link-to-prism">src/auth/auth.service.ts:409</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>access_token</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="../interfaces/AuthTokens.html" target="_self" >Promise&lt;AuthTokens&gt;</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="refreshToken"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>refreshToken</b></span>
                        <a href="#refreshToken"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>refreshToken(refreshToken: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="340"
                                    class="link-to-prism">src/auth/auth.service.ts:340</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Refreshes an access token using a refresh token</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>refreshToken</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;literal type&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="register"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>register</b></span>
                        <a href="#register"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>register(registerDto: <a href="../classes/RegisterDto.html" target="_self">RegisterDto</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="43"
                                    class="link-to-prism">src/auth/auth.service.ts:43</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Register a new user with email and password (for staff)</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>registerDto</td>
                                            <td>
                                                            <code><a href="../classes/RegisterDto.html" target="_self" >RegisterDto</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>unknown</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="signJwt"></a>
                    <span class="name">
                            <span class="modifier">Public</span>
                        <span ><b>signJwt</b></span>
                        <a href="#signJwt"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>signJwt(payload: <a href="../interfaces/TokenPayload.html" target="_self">TokenPayload</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="456"
                                    class="link-to-prism">src/auth/auth.service.ts:456</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>payload</td>
                                            <td>
                                                            <code><a href="../interfaces/TokenPayload.html" target="_self" >TokenPayload</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="validateToken"></a>
                    <span class="name">
                            <span class="modifier">Async</span>
                        <span ><b>validateToken</b></span>
                        <a href="#validateToken"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                        <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>validateToken(token: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank">string</a>)</code>
                </td>
            </tr>


                    <tr>
                        <td class="col-md-4">
                            <div class="io-line">Defined in <a href="" data-line="314"
                                    class="link-to-prism">src/auth/auth.service.ts:314</a></div>
                        </td>
                    </tr>


            <tr>
                <td class="col-md-4">
                        <div class="io-description"><p>Validates a JWT token</p>
</div>

                            <div class="io-description">
                                <b>Parameters :</b>
                                
                                <table class="params">
                                    <thead>
                                        <tr>
                                            <td>Name</td>
                                                <td>Type</td>
                                            <td>Optional</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                                <td>token</td>
                                            <td>
                                                            <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
                                            </td>

                                            <td>
                                                    No
                                            </td>


                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="io-description">
                            <b>Returns : </b>    <code>Promise&lt;TokenPayload&gt;</code>

                        </div>
                            <div class="io-description">
                                
                            </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>
            <section data-compodoc="block-properties">
    
    <h3 id="inputs">
        Properties
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="logger"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                            <span class="modifier">Readonly</span>
                        <span ><b>logger</b></span>
                        <a href="#logger"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Default value : </i><code>new Logger(AuthService.name)</code>
                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="27" class="link-to-prism">src/auth/auth.service.ts:27</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="supabase"></a>
                    <span class="name">
                            <span class="modifier">Private</span>
                        <span ><b>supabase</b></span>
                        <a href="#supabase"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
                <tr>
                    <td class="col-md-4">
                        <i>Type : </i>    <code>SupabaseClient</code>

                    </td>
                </tr>
                    <tr>
                        <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="26" class="link-to-prism">src/auth/auth.service.ts:26</a></div>
                        </td>
                    </tr>


        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import {
  Injectable,
  UnauthorizedException,
  InternalServerErrorException,
  Logger,
  BadRequestException,
  ConflictException,
} from &quot;@nestjs/common&quot;;
import { ConfigService } from &quot;@nestjs/config&quot;;
import { JwtService } from &quot;@nestjs/jwt&quot;;
import { createClient, SupabaseClient } from &quot;@supabase/supabase-js&quot;;
import { PrismaService } from &quot;../prisma/prisma.service&quot;;
import {
  SupabaseUser,
  TokenPayload,
  AuthTokens,
} from &quot;../common/interfaces/auth.interface&quot;;
import { UserRole, UserStatus } from &quot;@prisma/client&quot;;
import * as bcrypt from &quot;bcrypt&quot;;
import { RegisterDto, LoginDto } from &quot;./dto/auth.dto&quot;;
import { config } from &quot;dotenv&quot;;
config();

@Injectable()
export class AuthService {
  private supabase: SupabaseClient;
  private readonly logger &#x3D; new Logger(AuthService.name);

  constructor(
    private readonly configService: ConfigService,
    private readonly jwtService: JwtService,
    private readonly prisma: PrismaService,
  ) {
    this.supabase &#x3D; createClient(
      this.configService.get&lt;string&gt;(&quot;SUPABASE_URL&quot;),
      this.configService.get&lt;string&gt;(&quot;SUPABASE_SERVICE_ROLE_KEY&quot;),
    );
  }

  /**
   * Register a new user with email and password (for staff)
   */
  async register(registerDto: RegisterDto) {
    this.logger.log(&#x60;Registering new user: ${registerDto.email}&#x60;);

    const { email, password, firstName, lastName, phone, role } &#x3D; registerDto;

    // Validate role (PATIENT not allowed for regular registration)
    const allowedRoles: UserRole[] &#x3D; [
      UserRole.EMERGENCY_CENTER,
      UserRole.HOSPITAL,
      UserRole.RESCUE_TEAM,
      UserRole.ADMIN,
    ];
    if (role &amp;&amp; !allowedRoles.includes(role)) {
      this.logger.warn(&#x60;Role not allowed: ${role}&#x60;);
      throw new BadRequestException(&quot;This role cannot be registered this way&quot;);
    }

    try {
      // Check if email already exists
      const existingUser &#x3D; await this.prisma.user.findUnique({
        where: { email },
      });

      if (existingUser) {
        this.logger.warn(&#x60;Email already exists: ${email}&#x60;);
        throw new ConflictException(&quot;This email is already in use&quot;);
      }

      // Hash password
      const saltRounds &#x3D; 10;
      const hashedPassword &#x3D; await bcrypt.hash(password, saltRounds);

      // Create new user
      const user &#x3D; await this.prisma.user.create({
        data: {
          email,
          password: hashedPassword,
          firstName,
          lastName,
          phone: phone || null,
          role: role || UserRole.ADMIN,
          status: UserStatus.ACTIVE,
        },
      });

      this.logger.log(&#x60;Successfully created new user: ${user.id}&#x60;);
      return user;
    } catch (error) {
      this.logger.error(&#x60;Error during registration: ${error.message}&#x60;, error.stack);
      throw error instanceof ConflictException
        ? error
        : new InternalServerErrorException(&quot;Cannot register user&quot;);
    }
  }

  /**
   * Login with email and password
   */
  async login(loginDto: LoginDto): Promise&lt;AuthTokens&gt; {
    this.logger.log(&#x60;Logging in user: ${loginDto.email}&#x60;);

    const { email, password } &#x3D; loginDto;

    try {
      // Find user and select password
      const user &#x3D; await this.prisma.user.findUnique({
        where: { email },
        select: {
          id: true,
          email: true,
          password: true,
          role: true,
          status: true,
        },
      });

      if (!user || !user.password) {
        this.logger.warn(&#x60;User not found or no password set: ${email}&#x60;);
        throw new UnauthorizedException(&quot;Invalid email or password&quot;);
      }

      // Verify password
      const isPasswordValid &#x3D; await bcrypt.compare(password, user.password);
      if (!isPasswordValid) {
        this.logger.warn(&#x60;Invalid password for: ${email}&#x60;);
        throw new UnauthorizedException(&quot;Invalid email or password&quot;);
      }

      if (user.status !&#x3D;&#x3D; UserStatus.ACTIVE) {
        this.logger.warn(&#x60;User is not active: ${email}&#x60;);
        throw new UnauthorizedException(&quot;This account is disabled&quot;);
      }

      // Generate JWT token
      const payload: TokenPayload &#x3D; {
        sub: user.id,
        email: user.email,
        role: user.role.toString(),
      };

      const accessToken &#x3D; this.jwtService.sign(payload);

      // Generate refresh token using JWT
      const refreshToken &#x3D; this.jwtService.sign(payload, {
        secret: this.configService.get&lt;string&gt;(&quot;JWT_REFRESH_SECRET&quot;),
        expiresIn: this.configService.get&lt;string&gt;(&quot;JWT_REFRESH_EXPIRES_IN&quot;, &quot;30d&quot;),
      });

      this.logger.log(&#x60;Login successful for user: ${user.id}&#x60;);
      return {
        access_token: accessToken,
        refresh_token: refreshToken,
        token_type: &quot;Bearer&quot;,
        expires_in: parseInt(this.configService.get(&quot;JWT_EXPIRES_IN&quot;, &quot;604800&quot;)),
      };
    } catch (error) {
      this.logger.error(&#x60;Error during login: ${error.message}&#x60;, error.stack);
      throw error instanceof UnauthorizedException
        ? error
        : new InternalServerErrorException(&quot;Cannot login&quot;);
    }
  }

  /**
   * Generates an authorization URL for the specified OAuth provider
   */
  async generateAuthUrl(provider: string): Promise&lt;string&gt; {
    const validProviders &#x3D; [&quot;google&quot;, &quot;facebook&quot;, &quot;apple&quot;];

    this.logger.log(&#x60;Generating auth URL for provider: ${provider}&#x60;);

    if (!validProviders.includes(provider)) {
      this.logger.error(&#x60;Unsupported provider: ${provider}&#x60;);
      throw new BadRequestException(&#x60;Unsupported provider: ${provider}&#x60;);
    }

    try {
      const redirectUrl &#x3D; this.configService.get&lt;string&gt;(&quot;OAUTH_REDIRECT_URL&quot;);
      this.logger.log(&#x60;Redirect URL: ${redirectUrl}&#x60;);

      const { data, error } &#x3D; await this.supabase.auth.signInWithOAuth({
        provider: provider as any,
        options: {
          redirectTo: redirectUrl,
          queryParams: {
            response_type: &quot;code&quot;,
            access_type: &quot;offline&quot;,
          },
        },
      });

      if (error) {
        this.logger.error(&#x60;Cannot generate auth URL: ${error.message}&#x60;);
        throw new InternalServerErrorException(&quot;Cannot generate authentication URL&quot;);
      }

      this.logger.log(&#x60;Successfully generated auth URL: ${data.url}&#x60;);
      return data.url;
    } catch (error) {
      this.logger.error(
        &#x60;Error generating ${provider} auth URL: ${error.message}&#x60;,
        error.stack,
      );
      throw new InternalServerErrorException(&quot;Cannot initiate OAuth flow&quot;);
    }
  }

  /**
   * Handles the OAuth callback from providers
   */
  async handleOAuthCallback(provider: string, code: string): Promise&lt;AuthTokens&gt; {
    this.logger.log(&#x60;Handling OAuth callback for provider: ${provider} with code: ${code}&#x60;);

    try {
      const { data, error } &#x3D; await this.supabase.auth.exchangeCodeForSession(code);

      if (error || !data?.session) {
        this.logger.error(&#x60;OAuth code exchange failed: ${error?.message}&#x60;);
        throw new UnauthorizedException(&quot;Cannot authenticate with provider&quot;);
      }

      this.logger.log(&#x60;OAuth session data: ${JSON.stringify(data)}&#x60;);

      const supabaseUser &#x3D; data.user as SupabaseUser;

      if (!supabaseUser || !supabaseUser.id) {
        this.logger.error(&quot;Invalid user data received from provider&quot;);
        throw new UnauthorizedException(&quot;Invalid user data received from provider&quot;);
      }

      const user &#x3D; await this.findOrCreateUser(supabaseUser, provider);

      const payload: TokenPayload &#x3D; {
        sub: user.id,
        email: user.email,
        role: user.role.toString(),
      };

      const accessToken &#x3D; this.jwtService.sign(payload);

      this.logger.log(&#x60;Generated access token for user: ${user.id}&#x60;);

      return {
        access_token: accessToken,
        refresh_token: data.session.refresh_token,
        token_type: &quot;Bearer&quot;,
        expires_in: parseInt(this.configService.get(&quot;JWT_EXPIRES_IN&quot;, &quot;604800&quot;)),
      };
    } catch (error) {
      this.logger.error(&#x60;Error handling OAuth callback: ${error.message}&#x60;, error.stack);
      if (error instanceof UnauthorizedException) {
        throw error;
      }
      throw new InternalServerErrorException(&quot;Cannot process authentication&quot;);
    }
  }

  /**
   * Find existing user or create a new one based on OAuth user data
   */
  public async findOrCreateUser(supabaseUser: SupabaseUser, provider: string) {
    this.logger.log(&#x60;Finding or creating user from provider: ${provider}&#x60;);

    try {
      let user &#x3D; await this.prisma.user.findUnique({
        where: { supabaseUserId: supabaseUser.id },
      });

      if (!user) {
        this.logger.log(&quot;User not found, creating new user&quot;);

        const { user_metadata } &#x3D; supabaseUser;

        let firstName &#x3D; &quot;&quot;;
        let lastName &#x3D; &quot;&quot;;

        if (user_metadata.full_name) {
          const nameParts &#x3D; user_metadata.full_name.split(&quot; &quot;);
          firstName &#x3D; nameParts[0] || &quot;&quot;;
          lastName &#x3D; nameParts.slice(1).join(&quot; &quot;) || &quot;&quot;;
        } else if (user_metadata.name) {
          const nameParts &#x3D; user_metadata.name.split(&quot; &quot;);
          firstName &#x3D; nameParts[0] || &quot;&quot;;
          lastName &#x3D; nameParts.slice(1).join(&quot; &quot;) || &quot;&quot;;
        }

        user &#x3D; await this.prisma.user.create({
          data: {
            email: supabaseUser.email,
            firstName,
            lastName,
            role: UserRole.PATIENT,
            profileImageUrl: user_metadata.avatar_url || user_metadata.picture,
            supabaseUserId: supabaseUser.id,
            status: UserStatus.ACTIVE,
          },
        });

        this.logger.log(&#x60;Created new user from ${provider} OAuth: ${user.id}&#x60;);
      }

      return user;
    } catch (error) {
      this.logger.error(&#x60;Error finding/creating user: ${error.message}&#x60;, error.stack);
      throw new InternalServerErrorException(&quot;Cannot process user data&quot;);
    }
  }

  /**
   * Validates a JWT token
   */
  async validateToken(token: string): Promise&lt;TokenPayload&gt; {
    this.logger.log(&#x60;Validating token: ${token}&#x60;);

    try {
      const payload &#x3D; this.jwtService.verify&lt;TokenPayload&gt;(token);

      const user &#x3D; await this.prisma.user.findUnique({
        where: { id: payload.sub },
      });

      if (!user || user.status !&#x3D;&#x3D; UserStatus.ACTIVE) {
        this.logger.error(&quot;User not found or inactive&quot;);
        throw new UnauthorizedException(&quot;User not found or inactive&quot;);
      }

      this.logger.log(&#x60;Token validation successful for user: ${payload.sub}&#x60;);
      return payload;
    } catch (error) {
      this.logger.error(&#x60;Error validating token: ${error.message}&#x60;, error.stack);
      throw new UnauthorizedException(&quot;Invalid token&quot;);
    }
  }

  /**
   * Refreshes an access token using a refresh token
   */
  async refreshToken(refreshToken: string): Promise&lt;{ access_token: string }&gt; {
    this.logger.log(&#x60;Refreshing token with refresh token&#x60;);

    try {
      // Check if it&#x27;s a refresh token from OAuth (Supabase) or regular login
      try {
        // Try to verify as JWT refresh token
        const payload &#x3D; this.jwtService.verify&lt;TokenPayload&gt;(refreshToken, {
          secret: this.configService.get&lt;string&gt;(&quot;JWT_REFRESH_SECRET&quot;),
        });

        // Find user
        const user &#x3D; await this.prisma.user.findUnique({
          where: { id: payload.sub },
        });

        if (!user || user.status !&#x3D;&#x3D; UserStatus.ACTIVE) {
          this.logger.error(&quot;User not found or inactive&quot;);
          throw new UnauthorizedException(&quot;User not found or inactive&quot;);
        }

        // Generate new access token
        const newPayload: TokenPayload &#x3D; {
          sub: user.id,
          email: user.email,
          role: user.role.toString(),
        };

        this.logger.log(&#x60;Generated new access token for user: ${user.id}&#x60;);
        return {
          access_token: this.jwtService.sign(newPayload),
        };
      } catch (jwtError) {
        // If not a JWT refresh token, try Supabase (for OAuth)
        const { data, error } &#x3D; await this.supabase.auth.refreshSession({
          refresh_token: refreshToken,
        });

        if (error || !data?.session) {
          this.logger.error(&#x60;Cannot refresh session: ${error?.message}&#x60;);
          throw new UnauthorizedException(&quot;Invalid refresh token&quot;);
        }

        const user &#x3D; await this.prisma.user.findUnique({
          where: { supabaseUserId: data.user.id },
        });

        if (!user || user.status !&#x3D;&#x3D; UserStatus.ACTIVE) {
          this.logger.error(&quot;User not found or inactive&quot;);
          throw new UnauthorizedException(&quot;User not found or inactive&quot;);
        }

        const payload: TokenPayload &#x3D; {
          sub: user.id,
          email: user.email,
          role: user.role.toString(),
        };

        this.logger.log(&#x60;Generated new access token for user: ${user.id}&#x60;);
        return {
          access_token: this.jwtService.sign(payload),
        };
      }
    } catch (error) {
      this.logger.error(&#x60;Error refreshing token: ${error.message}&#x60;, error.stack);
      throw new UnauthorizedException(&quot;Cannot refresh token&quot;);
    }
  }

  async loginWithSupabaseToken(access_token: string): Promise&lt;AuthTokens&gt; {
    this.logger.log(&#x60;Validating access token from Supabase&#x60;);

    try {
      const { data, error } &#x3D; await this.supabase.auth.getUser(access_token);

      if (error || !data?.user) {
        this.logger.error(&#x60;Cannot validate access token: ${error?.message}&#x60;);
        throw new UnauthorizedException(&quot;Cannot validate token&quot;);
      }

      const supabaseUser &#x3D; data.user as SupabaseUser;

      const user &#x3D; await this.findOrCreateUser(supabaseUser, &quot;supabase&quot;);

      const payload: TokenPayload &#x3D; {
        sub: user.id,
        email: user.email,
        role: user.role.toString(),
      };

      const jwtAccessToken &#x3D; this.jwtService.sign(payload);
      const jwtRefreshToken &#x3D; this.jwtService.sign(payload, {
        secret: this.configService.get&lt;string&gt;(&quot;JWT_REFRESH_SECRET&quot;),
        expiresIn: this.configService.get&lt;string&gt;(&quot;JWT_REFRESH_EXPIRES_IN&quot;, &quot;30d&quot;),
      });

      return {
        access_token: jwtAccessToken,
        refresh_token: jwtRefreshToken,
        token_type: &quot;Bearer&quot;,
        expires_in: parseInt(this.configService.get(&quot;JWT_EXPIRES_IN&quot;, &quot;604800&quot;)),
      };
    } catch (error) {
      this.logger.error(&#x60;Error logging in with Supabase token: ${error.message}&#x60;, error.stack);
      throw new InternalServerErrorException(&quot;Cannot login with Supabase token&quot;);
    }
  }

  public async getUserFromAccessToken(accessToken: string): Promise&lt;SupabaseUser&gt; {
    const { data, error } &#x3D; await this.supabase.auth.getUser(accessToken);
    if (error || !data?.user) {
      throw new UnauthorizedException(&#x27;Cannot authenticate with provider&#x27;);
    }
    return data.user as SupabaseUser;
  }

  public signJwt(payload: TokenPayload): string {
    return this.jwtService.sign(payload);
  }
}</code></pre>
    </div>

</div>













                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'AuthService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
